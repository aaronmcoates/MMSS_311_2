---
title: "Final Project"
author: "Aaron Coates"
date: "6/8/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, results='hide'}
setwd("/Users/aaroncoates/Documents/GitHub/MMSS_311_2")

library(tidytext)
library(tm)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(proxy)
library(fields)
library(mixtools)
library(xml2)
library(rvest)
library(maps)
library(mapdata)
library(devtools)
library(ggmap)
library(tidyr)
library(RColorBrewer)
```

USAData <- read_csv('/Users/aaroncoates/Desktop/ML Final/DataUSA Health and Safety.csv')
GoodVars <- c(1, 7, 12, 17, 22)
USAData <- USAData[ ,GoodVars]
usanames <- c("FIPS", "Obesity", "Smoking", "AirPol", "Crime")
names(USAData) <- usanames
USAData$FIPS <- gsub("^.*US", "", USAData$FIPS) %>%
  as.numeric()

MedHouseInc <- read_csv('/Users/aaroncoates/Desktop/ML Final/MedHousInc.csv')
MedHouseInc <- MedHouseInc[, 1:3]
HSDiploma <- read_csv('/Users/aaroncoates/Desktop/ML Final/HSDiploma.csv')
HSDiploma <- HSDiploma[, 2:3]
WhitePop <- read_csv('/Users/aaroncoates/Desktop/ML Final/WhitePop.csv')
WhitePop <- WhitePop[,2:3]
FamHouseholds <- read_csv('/Users/aaroncoates/Desktop/ML Final/FamHouseholds.csv')
FamHouseholds <- FamHouseholds[,2:3]
UnempRate <- read_csv('/Users/aaroncoates/Desktop/ML Final/UnempRate.csv')
UnempRate <- UnempRate[,2:3]

StatsAmerica <- inner_join(MedHouseInc, HSDiploma, "FIPS Code") %>%
  inner_join(WhitePop, "FIPS Code") %>%
  inner_join(FamHouseholds, "FIPS Code") %>%
  inner_join(UnempRate, "FIPS Code")
statnames <- c("County", "FIPS", "MedHousInc", "HSDipl", "White", "FamHous", "UnempRate")
names(StatsAmerica) <- statnames

DataSet <- inner_join(StatsAmerica, USAData, "FIPS")

sum(is.na(DataSet$MedHousInc))
sum(is.na(DataSet$HSDipl))
sum(is.na(DataSet$White))
sum(is.na(DataSet$FamHous))
sum(is.na(DataSet$UnempRate))
sum(is.na(DataSet$Obesity))
sum(is.na(DataSet$Smoking))
sum(is.na(DataSet$AirPol))
sum(is.na(DataSet$Crime))

FillAirPol <- mean(DataSet$AirPol, na.rm=TRUE)
DataSet$AirPol[is.na(DataSet$AirPol)] <- FillAirPol
FillCrime <- mean(DataSet$Crime, na.rm=TRUE)
DataSet$Crime[is.na(DataSet$Crime)] <- FillCrime

DataSet <- apply(DataSet, 2, function(x) gsub("[$,%]", "", x)) %>%
  as.data.frame()

VarsOnly <- DataSet[3:11] %>%
  apply(2, as.numeric)
scaledVars <- scale(VarsOnly) %>%
  as.data.frame()

set.seed(100)
WCSS <- numeric(30)
for (i in 1:30){
  km <- kmeans(scaledVars, i, nstart=100)
  WCSS[i] <- km$tot.withinss
} 

WCSS<- as.data.frame(WCSS)
WCSS$k <- c(1:30)
ggplot(WCSS, aes(k, WCSS)) + geom_line() + geom_point() + 
  ggtitle("Elbow Plot") + xlab("Number of Clusters") + 
  ylab("Within-Cluster Sum of Squares")

KMeans <- kmeans(scaledVars, 12, nstart=100)

DataSet$Clusters <-KMeans$cluster %>%
  as.factor()


GraphData <- DataSet[ ,c(1, 12)]
GraphNames <- c("subregion", "cluster")
names(GraphData) <- GraphNames

USA <- map_data("usa")
Counties <- map_data("county")
GraphData$subregion <- as.character(tolower(gsub(" County ..$", "", GraphData$subregion)))
Counties$subregion <- as.character(Counties$subregion)

FinalGraph <- inner_join(GraphData, Counties, 'subregion')

ggplot(data = FinalGraph, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + geom_polygon(data = USA, aes(x=long, y = lat, group = group)) +
  geom_polygon(data = FinalGraph, aes(fill = cluster), color = "black", size=.05) +
  theme_bw() + scale_fill_brewer(palette = 'Paired')

Centers <- as.data.frame(KMeans$centers)
Centers$Clusters <- as.factor(c(1:12))
Centers <- gather(Centers, Variable, Value, -Clusters)

ggplot(Centers, aes(Clusters, Variable, 
                    fill=cut(Value, c(-20, -10, -3, -2, -1, -.5, 0, .5, 1, 2, 3, 10, 20)))) +
  geom_raster() + scale_fill_brewer(palette = "PiYG") +
  guides(fill=guide_legend(title="Proportion of State")) + ggtitle('State County Proportion per Cluster')

ClusterTotals <- DataSet %>%
  group_by(Clusters) %>%
  count()

ggplot(ClusterTotals, aes("", n, fill=Clusters)) +
    geom_bar(width = 1, stat = "identity") + coord_polar("y", start=0)

DataSet$State <- str_sub(DataSet$County, -2, -1)
table(DataSet$State, DataSet$Clusters)

StateTable <- DataSet %>%
  group_by(State, Clusters) %>%
  count()
StateTable$Clusters <- as.integer(StateTable$Clusters)
StateTable <- StateTable %>%
  group_by(State) %>%
  complete(Clusters = seq(1, 12), fill=list(n=0))
StateTable$Clusters <- as.factor(StateTable$Clusters)

StateMatrix <- spread(StateTable, key = "State", value = "n") %>%
  as.data.frame()
StateMatrix <- StateMatrix[ ,2:52]
StateMatrix[is.na(StateMatrix)] <- 0

CountyTotals <- colSums(StateMatrix) %>%
  as.data.frame()
colnames(CountyTotals) <- 'Total'
CountyTotals$State <- rownames(CountyTotals)

StateTable <- inner_join(StateTable, CountyTotals, 'State')
StateTable$Prop <- StateTable$n / StateTable$Total

ggplot(StateTable, aes(Clusters, State, 
  fill=cut(Prop, c(1, .875, .75, .625, .5, .375, .25, .125, .0001, 0), 
           labels = c("0", "(0,.125]", "(.125, .25]", "(.25, .375]", "(.375, .5]",
                      "(.5, .625]", "(.625, .75]", "(.75, .875]", "(.875, 1]"), include.lowest = TRUE))) +
  geom_tile() + scale_fill_brewer(palette = "BuGn", direction=-1) + 
  guides(fill=guide_legend(title="Proportion of State")) + ggtitle('State County Proportion per Cluster')
```

```{r}

```

